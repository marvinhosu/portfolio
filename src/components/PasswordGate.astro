---
// Password gate component - protects the portfolio content
import { translations } from '../i18n/translations';

// Get both language translations
const en = translations.en;
const de = translations.de;
---

<div id="password-gate" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-50 dark:bg-gray-900">
  <div class="mx-4 w-full max-w-md rounded-2xl bg-white dark:bg-gray-800 p-8 shadow-xl border border-gray-200 dark:border-gray-700">
    <h1 class="mb-2 text-3xl font-bold text-gray-900 dark:text-gray-100" data-lang="en">{en.passwordGate.welcome}</h1>
    <h1 class="mb-2 text-3xl font-bold text-gray-900 dark:text-gray-100" data-lang="de">{de.passwordGate.welcome}</h1>
    <p class="mb-6 text-gray-600 dark:text-gray-400" data-lang="en">{en.passwordGate.enterPassword}</p>
    <p class="mb-6 text-gray-600 dark:text-gray-400" data-lang="de">{de.passwordGate.enterPassword}</p>

    <form id="password-form" class="space-y-4">
      <div>
        <input
          type="password"
          id="password-input"
          data-lang="en"
          placeholder={en.passwordGate.passwordPlaceholder}
          class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 py-3 focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:focus:ring-blue-400/20"
          autofocus
        />
        <input
          type="password"
          id="password-input-de"
          data-lang="de"
          placeholder={de.passwordGate.passwordPlaceholder}
          class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 py-3 focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:focus:ring-blue-400/20"
          autofocus
        />
      </div>

      <button
        type="submit"
        data-lang="en"
        class="w-full rounded-lg bg-gray-900 dark:bg-gray-100 px-4 py-3 font-medium text-white dark:text-gray-900 transition-colors hover:bg-gray-800 dark:hover:bg-gray-200"
      >
        {en.passwordGate.enterButton}
      </button>
      <button
        type="submit"
        data-lang="de"
        class="w-full rounded-lg bg-gray-900 dark:bg-gray-100 px-4 py-3 font-medium text-white dark:text-gray-900 transition-colors hover:bg-gray-800 dark:hover:bg-gray-200"
      >
        {de.passwordGate.enterButton}
      </button>

      <p id="error-message-en" data-lang="en" class="hidden text-sm text-red-600 dark:text-red-400">
        {en.passwordGate.incorrectPassword}
      </p>
      <p id="error-message-de" data-lang="de" class="hidden text-sm text-red-600 dark:text-red-400">
        {de.passwordGate.incorrectPassword}
      </p>
    </form>
  </div>
</div>

<script>
  // Password configuration
  // The password hash is loaded from environment variables at build time
  // For development: Set PUBLIC_PASSWORD_HASH in .env file
  // For production: Set PUBLIC_PASSWORD_HASH in your deployment platform (Vercel/Netlify/Cloudflare)
  // To generate a hash: echo -n "your-password" | sha256sum
  const PASSWORD_HASH = import.meta.env.PUBLIC_PASSWORD_HASH || "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"; // Fallback: "password" for development

  // Check if already authenticated
  if (sessionStorage.getItem('portfolio_authenticated') === 'true') {
    const gate = document.getElementById('password-gate');
    if (gate) gate.style.display = 'none';
  }

  // Brute force protection
  const MAX_ATTEMPTS = 5;
  const LOCKOUT_DURATION = 15 * 60 * 1000; // 15 minutes in milliseconds

  function getAttempts() {
    const data = localStorage.getItem('pw_attempts');
    if (!data) return { count: 0, lockoutUntil: 0 };
    return JSON.parse(data);
  }

  function setAttempts(count: number, lockoutUntil: number) {
    localStorage.setItem('pw_attempts', JSON.stringify({ count, lockoutUntil }));
  }

  function isLockedOut(): boolean {
    const attempts = getAttempts();
    if (attempts.lockoutUntil > Date.now()) {
      return true;
    }
    // Lockout expired, reset
    if (attempts.lockoutUntil > 0) {
      setAttempts(0, 0);
    }
    return false;
  }

  function getRemainingLockoutTime(): number {
    const attempts = getAttempts();
    return Math.ceil((attempts.lockoutUntil - Date.now()) / 1000 / 60); // minutes
  }

  // Handle form submission
  const form = document.getElementById('password-form');
  const inputEn = document.getElementById('password-input') as HTMLInputElement;
  const inputDe = document.getElementById('password-input-de') as HTMLInputElement;
  const errorEn = document.getElementById('error-message-en');
  const errorDe = document.getElementById('error-message-de');

  async function hashPassword(password: string): Promise<string> {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  // Helper function to get current language
  function getCurrentLang(): 'en' | 'de' {
    return (localStorage.getItem('language') || 'en') as 'en' | 'de';
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get current language
    const currentLang = getCurrentLang();
    const input = currentLang === 'en' ? inputEn : inputDe;
    const errorMessage = currentLang === 'en' ? errorEn : errorDe;

    // Check if locked out
    if (isLockedOut()) {
      const minutes = getRemainingLockoutTime();

      if (errorMessage) {
        errorMessage.textContent = currentLang === 'en'
          ? `Too many attempts. Please try again in ${minutes} minute${minutes !== 1 ? 's' : ''}.`
          : `Zu viele Versuche. Bitte versuchen Sie es in ${minutes} Minute${minutes !== 1 ? 'n' : ''} erneut.`;
        errorMessage.classList.remove('hidden');
      }

      if (input) input.value = '';
      form?.classList.add('animate-shake');
      setTimeout(() => form?.classList.remove('animate-shake'), 500);
      return;
    }

    const enteredPassword = input?.value || '';
    const enteredHash = await hashPassword(enteredPassword);

    if (enteredHash === PASSWORD_HASH) {
      // Correct password - reset attempts
      setAttempts(0, 0);
      sessionStorage.setItem('portfolio_authenticated', 'true');
      const gate = document.getElementById('password-gate');
      if (gate) {
        gate.style.opacity = '0';
        gate.style.transition = 'opacity 0.3s ease-out';
        setTimeout(() => {
          gate.style.display = 'none';
        }, 300);
      }
    } else {
      // Wrong password - increment attempts
      const attempts = getAttempts();
      const newCount = attempts.count + 1;

      if (newCount >= MAX_ATTEMPTS) {
        // Lock out user
        const lockoutUntil = Date.now() + LOCKOUT_DURATION;
        setAttempts(newCount, lockoutUntil);

        if (errorMessage) {
          errorMessage.textContent = currentLang === 'en'
            ? 'Too many failed attempts. Locked out for 15 minutes.'
            : 'Zu viele fehlgeschlagene Versuche. Gesperrt fÃ¼r 15 Minuten.';
          errorMessage.classList.remove('hidden');
        }
      } else {
        // Show remaining attempts
        setAttempts(newCount, 0);
        const remaining = MAX_ATTEMPTS - newCount;

        if (errorMessage) {
          errorMessage.textContent = currentLang === 'en'
            ? `Incorrect password. ${remaining} attempt${remaining !== 1 ? 's' : ''} remaining.`
            : `Falsches Passwort. Noch ${remaining} Versuch${remaining !== 1 ? 'e' : ''}.`;
          errorMessage.classList.remove('hidden');
        }
      }

      if (inputEn) inputEn.value = '';
      if (inputDe) inputDe.value = '';
      input?.focus();

      // Shake animation
      form?.classList.add('animate-shake');
      setTimeout(() => {
        form?.classList.remove('animate-shake');
      }, 500);
    }
  });
</script>

<style>
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
  }

  .animate-shake {
    animation: shake 0.5s;
  }
</style>
