---
// Password gate component - protects the portfolio content
import { translations } from '../i18n/translations';

// Get both language translations
const en = translations.en;
const de = translations.de;
---

<div id="password-gate" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-50 dark:bg-gray-900">
  <div class="mx-4 w-full max-w-md rounded-2xl bg-white dark:bg-gray-800 p-8 shadow-xl border border-gray-200 dark:border-gray-700">
    <h1 class="mb-2 text-3xl font-bold text-gray-900 dark:text-gray-100" data-lang="en">{en.passwordGate.welcome}</h1>
    <h1 class="mb-2 text-3xl font-bold text-gray-900 dark:text-gray-100" data-lang="de">{de.passwordGate.welcome}</h1>
    <p class="mb-6 text-gray-600 dark:text-gray-400" data-lang="en">{en.passwordGate.enterPassword}</p>
    <p class="mb-6 text-gray-600 dark:text-gray-400" data-lang="de">{de.passwordGate.enterPassword}</p>

    <form id="password-form" class="space-y-4">
      <div>
        <input
          type="password"
          id="password-input"
          data-lang="en"
          placeholder={en.passwordGate.passwordPlaceholder}
          class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 py-3 focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:focus:ring-blue-400/20"
          autofocus
        />
        <input
          type="password"
          id="password-input-de"
          data-lang="de"
          placeholder={de.passwordGate.passwordPlaceholder}
          class="w-full rounded-lg border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 placeholder:text-gray-500 dark:placeholder:text-gray-400 px-4 py-3 focus:border-blue-500 dark:focus:border-blue-400 focus:outline-none focus:ring-2 focus:ring-blue-500/20 dark:focus:ring-blue-400/20"
          autofocus
        />
      </div>

      <button
        type="submit"
        data-lang="en"
        class="w-full rounded-lg bg-gray-900 dark:bg-gray-100 px-4 py-3 font-medium text-white dark:text-gray-900 transition-colors hover:bg-gray-800 dark:hover:bg-gray-200"
      >
        {en.passwordGate.enterButton}
      </button>
      <button
        type="submit"
        data-lang="de"
        class="w-full rounded-lg bg-gray-900 dark:bg-gray-100 px-4 py-3 font-medium text-white dark:text-gray-900 transition-colors hover:bg-gray-800 dark:hover:bg-gray-200"
      >
        {de.passwordGate.enterButton}
      </button>

      <p id="error-message-en" data-lang="en" class="hidden text-sm text-red-600 dark:text-red-400">
        {en.passwordGate.incorrectPassword}
      </p>
      <p id="error-message-de" data-lang="de" class="hidden text-sm text-red-600 dark:text-red-400">
        {de.passwordGate.incorrectPassword}
      </p>
    </form>
  </div>
</div>

<script>
  // Password configuration
  // The password hash is loaded from environment variables at build time
  // For development: Set PUBLIC_PASSWORD_HASH in .env file
  // For production: Set PUBLIC_PASSWORD_HASH in your deployment platform (Vercel/Netlify/Cloudflare)
  // To generate a hash: echo -n "your-password" | sha256sum
  const PASSWORD_HASH = import.meta.env.PUBLIC_PASSWORD_HASH || "5e884898da28047151d0e56f8dc6292773603d0d6aabbdd62a11ef721d1542d8"; // Fallback: "password" for development

  // Check if already authenticated
  if (sessionStorage.getItem('portfolio_authenticated') === 'true') {
    const gate = document.getElementById('password-gate');
    if (gate) gate.style.display = 'none';
  }

  // Handle form submission
  const form = document.getElementById('password-form');
  const inputEn = document.getElementById('password-input') as HTMLInputElement;
  const inputDe = document.getElementById('password-input-de') as HTMLInputElement;
  const errorEn = document.getElementById('error-message-en');
  const errorDe = document.getElementById('error-message-de');

  async function hashPassword(password: string): Promise<string> {
    const encoder = new TextEncoder();
    const data = encoder.encode(password);
    const hashBuffer = await crypto.subtle.digest('SHA-256', data);
    const hashArray = Array.from(new Uint8Array(hashBuffer));
    return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
  }

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    // Get active input based on which one is visible
    const input = inputEn?.style.display !== 'none' ? inputEn : inputDe;
    const errorMessage = inputEn?.style.display !== 'none' ? errorEn : errorDe;

    const enteredPassword = input?.value || '';
    const enteredHash = await hashPassword(enteredPassword);

    if (enteredHash === PASSWORD_HASH) {
      // Correct password
      sessionStorage.setItem('portfolio_authenticated', 'true');
      const gate = document.getElementById('password-gate');
      if (gate) {
        gate.style.opacity = '0';
        gate.style.transition = 'opacity 0.3s ease-out';
        setTimeout(() => {
          gate.style.display = 'none';
        }, 300);
      }
    } else {
      // Wrong password
      errorMessage?.classList.remove('hidden');
      if (inputEn) inputEn.value = '';
      if (inputDe) inputDe.value = '';
      input?.focus();

      // Shake animation
      form?.classList.add('animate-shake');
      setTimeout(() => {
        form?.classList.remove('animate-shake');
      }, 500);
    }
  });
</script>

<style>
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
    20%, 40%, 60%, 80% { transform: translateX(5px); }
  }

  .animate-shake {
    animation: shake 0.5s;
  }
</style>
